---
title: 카프카 핵심 가이드 - 03 카프카에 메세지 쓰기
description: >-
  카프카 프로듀서를 사용하는 방법을 배워보자.
  KafkaProducer와 ProducerRecord 객체를 어떻게 생성하는지, 어떻게 카프카에 레코드를 전송하는지, 그에 따른 리턴이나 에러를 어떻게 처리하는지와 설정 옵션, 시리얼라이저 등을 살펴보자.
author: ggong
date: 2025-02-18 11:19:00 +0900
categories: [ Book, Kafka ]
tags: [ book, kafka, study, unclear ]
pin: false
media_subpath: '/assets/img/kafka'
references:
  - name: "카프카 핵심 가이드(그웬 샤피라, 토드 팔리노, 라지니 시바람, 크리트 페티 지음 / 이동진 옮김)"
    url: "https://product.kyobobook.co.kr/detail/S000201464167"
---

## 프로듀서 개요

서로 다른 요구 조건은 카프카에 메시지를 쓰기 위해 퓨로듀서 API를 사용하는 방식과 설정에 영향을 미친다.


![Build source](3-1.png){: .light .normal }
_카프카에 데이터를 전송할 때 수행되는 주요 단계들_

1. `ProducerRecord` 객체를 생성한다.
: 레코드가 저장될 토픽과 밸류 지정을 필수사항이다.
: 키와 파티션 지정은 선택사항이다.

2. 생성한 객체를 직렬화한다.
3. 해당 데이터를 파티셔너에게 보낸다.
: 파티션을 명시적으로 지정했다면 이 과정은 생략된다.
: 파티셔너는 파티션을 결정하는 역할을 한다.

4. 토픽 파티션에 저장될 레코드들을 모아 레코드 배치에 추가한다.
5. 별도의 스레드가 이 레코드 배치를 적절한 카프카 브로커에게 전송한다.
6. 브로커가 메시지를 받으면 응답을 돌려준다.
: 성공했을 경우에는 `RecordMetadata`를, 실패했을 때는 에러가 리턴된다.


## 카프카 프로듀서 생성하기

카프카에 메시지를 쓰려면 원하는 속성을 지정해서 프로듀서 객체를 생성해야한다.
이때 프로듀서는 아래의 3개의 필수 속성값을 갖는다.

### 필수 속성값

`bootstrap.servers`
: 프로듀서가 사용할 브로커의 `host:port` 목록이다.
: 모든 브로커를 포함할 필요는 없지만, 최소 2개 이상을 지정할 것을 권장한다.

`key.serializer`
: 키 값을 직렬화하기 위해 사용하는 시리얼라이저 클래스 이름이다.
: `org.apache.kafka.common.serialization.Serializer` 인터페이스를 구현하는 클래스의 이름이 지정되어야한다.
: `VoidSerializer`를 사용해 키 타입으로 `void`를 설정할 수 있다.
 
`value.serializer`
: 밸류 값을 직렬화하기 위해 사용하는 시리얼라이저 클래스 이름이다.


### 프로듀서의 생성 방법

```java
Properties kafkaProperties = new Properties();
kafkaProperties.put("bootstrap.servers", "broker1:9002,broker2:9002");
kafkaProperties.put("key.serializer", "org.apache.kafka.common.serialization.StringSerializer");
kafkaProperties.put("value.serializer", "org.apache.kafka.common.serialization.StringSerializer");

KafkaProcuder<String, String> producer = new KafkaProducer<String,String>(kafkaProperties);
```
_프로듀서의 생성방법_
{: .code-description }

- <span>1</span>`Properties` 생성 
- <span>3~4</span>메시지의 키값과 밸류값으로 문자열을 사용할 것이므로, 기본제공되는 시리얼라이저를 사용
- <span>6</span>`Properties`를 넘겨줌으로써 새로운 프로듀서 생성
{: .code-description }

### 메시지 전송 방법

파이어 앤 포켓
: 메시지를 서버에 전송만 하고 끝내는 방식으로, 성공 혹은 실패 여부에 관심을 두지 않는다.
: 프로듀서는 [재시도할 수 있는 실패](#카프카-프로듀서-생성하기-실패){: .question }에서는 재전송 실패를 하지만, 
재시도를 할 수 없는 에러 발생시에는 재시도 하지 않고 실패에 대한 처리가 없어 메시지가 유실되며 프로듀서는 알 수 없다.

동기적 전송
: 메시지를 전송하고 다음 메시지를 전송하기 전까지 `get()`을 호출해 작업이 완료될까지 기다려 성공 여부를 확인한다.

비동지적 전송
: 카프카는 언제나 비동기적으로 작동한다.
: 응답을 받는 시점에서 자동으로 콜백 함수가 호출된다.


## 카프카로 메시지 전달하기

```java
ProducerRecord<String,String> record =new ProducerRecord("CustomerCountry", "Precision Products", "France");
try{
    producer.send(redord);
}catch(Exception e){
    e.printStackTrace();  
}
```
_메시지 전송_
{: .code-description }

- <span>1</span>`ProducerRecord` 생성
- <span>3</span>`ProducerRecord`를 전송하기 위해 프로듀서 객체의 `send()` 사용
: 메시지는 버퍼에 저장 -> 별도에 스레드가 브로커로 보냄 -> `RecoredMetadata`를 포함한 `Future`객체를 리턴 -> 이 코드에서는 값을 무시함
- <span>6</span>프로듀서가 카프카로 메시지를 보내기 전에 에러가 발생할 경우, catch절이 실행
: ex) 직렬화 실패(SerializationException), 버퍼가 가득참(TimeoutException), 전송 작업을 수행하는 스레드에 인터럽트 발생시(InterruptException)등
{: .code-description }


### 동기적으로 메시지 전송하기

동기적으로 메시지를 전송할 경우 전송을 요청하는 스레드는 이 시간동안 아무것도 안하면서 기다려야해서 성능이 크게 낮아지기 때문에 잘 사용되지는 않는다.


```java
ProducerRecord<String,String> record =new ProducerRecord("CustomerCountry", "Precision Products", "France");
try{
    producer.send(redord).get();
}catch(Exception e){
    e.printStackTrace();  
}
```
_동기적으로 메시지 전송_
{: .code-description }

- <span>3</span> 카프카로부터 응답이 올 때까지 `Future.get()`을 사용해 대기 
: 성공적으로 전송되지 않았으면 예외를 발생시키고, 성공했다면 `RecordMetadata`객체를 받는데 여기에서 메시지가 쓰여진 오프셋 등의 메타데이터를 가져올 수 있다.
- <span>5</span> [재시도할 수 있는 실패](#카프카-프로듀서-생성하기-실패){: .question }라면 재시도 횟수를 넘었을 경우 실행되고, 재시도할 수 없는 실패라면 바로 실행된다. 
{: .code-description }



> 재시도할 수 있는 실패와 재시도할 수 없는 실패
> 재시도할 수 있는 실패
: 메시지를 다시 전송함으로써 해결될 수 있는 에러를 의미한다.
: 연결 에러 - 연결이 회복되면 해결될 수 있다.
>
> 재시도할 수 없는 실패
: 메시지 크기가 너무 큰 경우와 같이 재시도를 한다고 해서 해결되지 않는 에러를 의미한다.
>
> 재시도할 수 있는 실패에서는 카프카가 자동으로 재시도하도록 `KafkaProducer`를 설정할 수 있어, 이 경우 재전송 횟수를 다 소진하면 예외를 발생시킨다.
{: .prompt-question id="카프카-프로듀서-생성하기-실패" }

### 비동기적으로 메시지 전송하기




## 프로듀서 설정하기

## 시리얼라이저

## 파티션

## 헤더

## 쿼터, 스로틀링

## 요약
