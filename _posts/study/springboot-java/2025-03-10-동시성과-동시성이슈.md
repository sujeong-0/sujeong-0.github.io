---
title: Springboot Java - 효율성을 높이는 동시성, 그리고 피할 수 없는 동시성 이슈
description: >-
    보다 효율적인 처리를 위한 동시성, 하지만 항상 따라오는 동시성 이슈! 두개를 모두 알아보자.
author: ggong
date: 2025-03-10 23:11:34 +0900
categories: [Study,Springboot Java]
tags: [study,springboot-java,동시성,concurrency,parallelism,multi-thread,thread,non-blocking,asynchronous]
pin: false
media_subpath: '/assets/img/_posts/study/springboot-java'
references:
  - name: "Concurrent computing"
    url: "https://en.wikipedia.org/wiki/Concurrent_computing"
  - name: "Concurrency vs. Parallelism — A brief view"
    url: "https://medium.com/@itIsMadhavan/concurrency-vs-parallelism-a-brief-review-b337c8dac350"
---


## 동시성 이란?

### 두가지 의미?

동시성의 정확한 정의와 의미를 파악하기 위해 여러 글을 읽어보는데, 2가지로 나뉘어서 어느 것이 정확한 의미인지 헷갈렸다.

첫번째 동시성
: 시스템이 동시 실행 또는 시간 공유(컨텍스트 전환)를 통해 여러 작업을 실행하고 리소스를 공유하며 상호 작용을 관리하는 기능
: 병렬성, 멀티스레딩 및 멀티프로세싱, 동기화, 동시성 제어, 프로세스 간 통신와 같은 여러 아이디어를 포함하는 광범위한 개념

두번째 동시성
: 하나의 코어에서도 여러 작업을 번갈아 실행하면서 동시에 실행되는 것처럼 보이게 하는 방식
: 동시에 실행되는 것처럼 보이지만, 사실은 CPU가 작업을 빠르게 전환하여 그렇게 보이도록 하는 것

이렇게 두가지로 나뉘었는데, 
첫번째 의미는 아마 동시 컴퓨팅(Concurrent Computing)을 의미하고, 두번째는 논리적 동시성(Time-sharing)을 의미하는 것 같았다.

> 동시성이라는 용어가 이중적으로 사용되어 더 헷갈리게 느껴진 것 같다.

그럼 이 글에서 동시성은 첫번째 동시성인 동시 컴퓨팅에 대해 알아보려 한다.

#### 동시성과 관련된 용어 정리

병렬성
: 여러 처리 장치에서 동시 실행하는 것
: 멀티코어 CPU에서 각 작업이 병렬로 실행하는 방식으로 **동시성을 구현하여 물리적으로 동시에** 실행된다.

멀티스레딩
: 하나의 프로세스 내에서 여러 개의 스레드를 실행하는 방식으로 **동시성을 구현**하여 여러 작업을 실행될 수 있도록 한다.

멀티프로세싱
: 여러 개의 프로세스를 동시에 실행하는 방식으로 **동시성을 구현**하여 여러 프로그램이 실행될 수 있도록 한다.

동기화
: 동시성을 가진 여러 프로세스, 프로그램에서 각 스레드와 프로세스가 **같은 리소스에 접근해 발생할 수 있는 문제**를 안전하게 하는 방법이다.

동시성 제어
: 동시성을 효율적으로 처리하고 **충돌을 방지**하는 기법이다.

프로세스 간 통신
: 멀티프로세싱 환경에서, **각 작업끼리 데이터를 주고 받는 방법**이다.

조정
: 동시성을 구현한 방법에서 각 작업의 순서가 **적절한 순서로 실행되도록** 하는 기법이다.

## 동시성을 구현하는 방법

위에서 말한 것처럼 동시성은 동시 실행이나 시간 공유를 통해 여러 작업을 실행 및 리소스를 공유하는 기능이라고 했다.
이런 동시성은 여러가지 방법으로 구현되는데, 어떻게 구현되었는지 알아보자.

### 멀티스레딩과 멀티프로세싱

먼저 멀티스레딩은 하나의 프로세스 내에서 **여러 개의 스레드를 실행**해 동시성을 구현했다.

![싱글스레드와 멀티스레드](single-multi-thread.png){: .center w="750"}
_싱글스레드와 멀티스레드_

이렇게 여러개의 스레드를 이용해, 동시에 여러개의 작업이 실행 되는 것처럼 보이게한다.
만약 코어가 여러개라면 실제로 병렬적으로 수행도 가능하지만, 그림처럼 1개여도 컨텍스트 스위칭을 하며 동시에 실행되도록 한다.

멀티프로세싱은 멀티스레드와 비슷한 방식인데, 스레드에서 프로세스로 변경되었다는 점이 다르다.
그래서 방식은 같지만 스레드와 프로세스의 차이에서 발생하게된다.
스레드는 데이터 공유가 가능하고, 프로세스는 각자 자신만의 메모리 공간을 가지게 되어 공유가 어렵다는 점이다.

### 비동기 프로그래밍

![동기와 비동기](sync-async.png){: .center w="750"}
_동기와 비동기_

비동기 프로그래밍은, 위 그림에서와 같이 작업을 요청한 후 요청이 완료될때까지 기다리는 것이 아니라
완료가 된다면 callback을 호출하고, callback 호출에 의해 작업을 다시 진행하는 것이다.
물론 그림에서는 블로킹/논블로킹을 제외하기 위해 블로킹 작업으로 예시를 들었다.

예를 든다면, API 호출이나 DB 조회와 같은 작업이 작업2,작업3이라고 생각하면 좋을 것 같다.

### 논블로킹 I/O

![블로킹과 논 블로킹](block-non-block.png){: .center w="750"}
_블로킹과 논 블로킹_

논블로킹 I/O는 비동기와 비슷하지만, 작업2와 작업3의 완료 여부와 관계 없이 **자신의 작업을 계속한다**는 차이가 있다.
이렇게 되면 CPU가 유휴상태가 되지 않고, 지속적으로 다른 작업을 수행할 수 있어 CPU 리소스를 더 효율적으로 사용할 수 있다.

예시로는 파일 시스템에서 값을 읽거나 , DB와 연동하는 등의 작업이 있다.

> 비동기와 논블로킹이 유사하게 느껴진다면?
> 맞다. 두 개념의 목적이 동시에 다른 작업을 수행한다는 것으로 같기 때문에 그렇게 느껴진다.
> 이는 관점에 대한 차이인데, 이 두개가 너무 헷갈린다면 [비동기와 멀티스레딩](/posts/멀티스레딩과-비동기/)을 한번 읽어보자.
{: .prompt-info}

## 동시성과 병렬성

지금까지 동시성에 대해 알아봤다.
동시성과 비슷한 개념이 하나 더 있는데, 그건 병렬성이다. 
동시성이 포함하는 개념 중 하나인데, 어떤 차이가 있는지 보자.

![동시성과 병렬성](parallelism.png){: .center w="600"}
_동시성과 병렬성_

이 그림이 낯익을 수도 있다. 위에서 싱글스레드와 멀티스레드를 설명할 때 그림과 유사하다.
특히 코어가 1개인경우와 3개인 경우에 대한 차이라고 볼 수 있는데,
그 이유는 병렬성은 각 코어가 따로 실행하는 방식이기 때문이다.


> Concurrency is about dealing with lots of things at once. Parallelism is about doing lots of things at once.
> 동시성은 한번에 많은 일을 다루는 것이고, 병렬성은 한 번에 많은 일을 하는 것이다.
> 출처 : [Concurrency vs. Parallelism — A brief view](https://medium.com/@itIsMadhavan/concurrency-vs-parallelism-a-brief-review-b337c8dac350)
{: .prompt-info }

> 번역은 구글 번역을 이용했는데, 생각보다 잘 된 것 같다.

동시성과 병렬성의 차이를 잘 말해주는 문장인 것 같아 그대로 인용했다.
말 그대로 동시성은 진행중인 과정에서 **한번에 많은 일(=작업1, 작업2 등)을 다루는 것**이고, 병렬성은 아예 **물리적으로 동시에** 실행되는 것을 의미한다.

그래서 병렬성이 되기 위해서는 멀티 코어가 필수적이다. 멀티코어가 없는 상황에서는 병렬성이 아닌 마치 동시에 여러개가 되는 것처럼, 동시에 여러일을 하는 것처럼 보이는 것인 동시성이다.


병렬성
: 물리적으로 동시에, 한번에 많은 일을 하는 것
: 멀티 코어가 필수적

동시성
: 한번에 많은 일을 다루는 것
: 여러가지 일에 대해 컨텍스트 스위칭을 하며, 동시에 여러일을 하는 것처럼 보이게 함

## 동시성의 문제

동시성은 프로세스나 프로그램이 보다 효율적으로 동작할 수 있게 해주지만, 관련 된 문제도 많다.
동시성 환경에서는 어떤 문제가 발생될 수 있을까?

### 동시성 환경에서 발생되는 문제들

데이터 일관성 문제
: 여러 스레드가 공유 데이터를 처리할 때 발생하는 문제
: 경쟁 조건(Race Condition), 데이터 경합(Data Race), 메모리 일관성 문제(Memory Consistency Issue)

자원 접근 문제
: 특정 스레드가 자원을 차지한 상태에서, 다른 스레드가 실행되지 못하는 문제
: 데드락(Deadlock), 기아 상태(Starvation), 우선순위 반전(Priority Inversion)

동기화 문제
: 락(lock)이나 동기화 메커니즘이 올바르게 작동하지 않는 문제
: 불 완전한 동기화(Improper Synchronization), 스레드 안전성(Thread Safety Issue)

성능 문제
: 스레드 관리 또는 과도한 동기화로 인한 성능 저하
: 컨텍스트 스위칭 오버헤드(Context Switching Overhead), 라이브락(Livelock)


여러 문제들이 있는데, 내가 임의로 비슷해 보이는 문제들끼리 묶어 보았다. 
이 중에서 우리가 지금 볼 동기화는 데이터 일관성 문제를 해결하는 역할을 한다. 

먼저 데이터 일관성 문제에 대해 알아보고, 동기화로 해결하는 방법까지 보자.


### 데이터 일관성 문제

데이터 일관성 문제
: 여러 스레드가 공유 데이터에 읽고 쓰면서 발생하는 문제다.

중요 포인트는 **공유 데이터**에 했다는 것이다.

경쟁 조건(Race Condition)
: 두 개 이상의 스레드가 공유 자원(변수, 메모리, 파일 등)에 동시에 접근해 비정상적인 결과가 발생하는 문제
: 논리적인 실행 순서(조건문, 흐름 등)가 꼬여서 문제가 발생

데이터 경합(Data Race)
: 둘 이상의 스레드가 하나의 변수를 동시에 읽고 쓰면서, 올바르지 않은 값이 발생하는 문제
: 여러 스레드가 하나의 변수를 동시에 읽고 쓰면서 발생하는 문제

메모리 일관성 문제(Memory Consistency Issue)
: 멀티스레드 환경에서 한 스레드의 변경 사항이 다른 스레드에서 즉시 반영되지 않는 문제
: 변수 값이 변경되었음에도 불구하고, 다른 스레드에 변경된 내용이 반영되지 않아 여전히 이전 값을 보게 되어 생기는 문제
: CPU 캐시나 메모리 가시성 문제로 인해 최신 데이터가 보이지 않을 수 있음

이 3가지 문제에서 경쟁 조건과 데이터 경합은 유사하게 느껴지는데, 그 이유는 경쟁 조건이라는 문제 안에 데이터 경합이 포함되기 때문이다.
그래도 이해하기 위해 예제를 보자면,

```java
class BankAccount {
    private int balance = 100;

    public void withdraw(int amount) {
        if (balance >= amount) {
            balance -= amount;
        }
    }
}
```
- <span></span>


#### 해결 방법: 동기화

동기화
: 동시성 환경에서 여러 스레드/프로세스가 같은 자원에 접근할 때 발생하는 문제를 해결하는 기법
: 멀티스레딩, 멀티프로세싱 환경에서 데이터를 안전하게 보호하는 역할


## 동시성 제어

## 프로세스 간 통신

## 조정
